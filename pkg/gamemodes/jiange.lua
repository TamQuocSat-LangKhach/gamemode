local jiange_desc = [[
  
# 守卫剑阁简介

  剑阁即现位于四川盆地北部的剑阁县。三国时期，蜀相诸葛亮叹其地势险峻，易守难攻，遂在此修阁道，立剑门，置阁尉，设戍守，使其成为蜀地的军事要隘。后人有诗曰：“伏弩齐飞万点星，木门道上射雄兵。至今剑阁行人过，犹说军师旧日名。”

  三国末期，司马昭令钟会、邓艾、诸葛绪三路兵马大举伐蜀，蜀汉大将军姜维率军退守剑阁，据剑阁险道为屏障，凭借天险阻击魏军。魏军久攻不下，补给困难。而蜀军也面临着一旦剑阁失守则蜀汉不保的严峻局面。

  这场历史上决定了蜀国生死存亡的战役，如今被《三国杀OL》完美的还原到了游戏当中，“守卫剑阁”的重任也落到了三国杀玩家的肩上——三国杀最新PVP模式“守卫剑阁”隆重登场！

  究竟是助魏国一统天下，还是助蜀汉扭转乾坤，三国杀新模式守卫剑阁，让我们拭目以待！

  ---

  ## 规则说明

  游戏由8名玩家进行，分为蜀、魏两阵营，双方阵营各有两名普通武将、一名英魂武将、一名攻城器械。

  行动顺序为：
  
  - 魏势力武将-魏势力攻城器械-蜀势力武将-蜀势力英魂-蜀势力武将-蜀势力攻城器械-蜀势力武将-魏势力英魂
  
  胜利条件为消灭所有敌方阵营角色。

  本模式没有击杀奖惩！

  ---

  ## 选将

  所有角色从对应的武将池中同时选择武将：普通武将可以选择本势力的武将，英魂武将可以选择本势力的英魂，攻城器械可以选择本势力的攻城器械。本模式专用的英魂武将和攻城器械可以在游戏模式专属武将中查看。

  若启用副将，所有角色同时从本势力的武将池中各选择一名武将作为副将。

  由于是蜀、魏两阵营对战，非蜀魏势力武将和部分可变更技能、武将、势力的武将不会出现在武将池中。

  ---
  
  ## 随机事件

  选择武将前，从以下事件中随机出现一个事件，游戏开始前会为双方阵营所有角色添加对应事件的阵营技能。事件效果在游戏中可以点击左上角查看。注意，部分事件技能与身份局同名技能并不完全相同。

  **百步九折**：
  - 蜀势力技能〖志继〗：准备阶段或结束阶段，若你没有手牌，你回复1点体力或摸两张牌，减1点体力上限并获得技能〖观星〗。
  - 魏势力技能〖魏业〗：准备阶段，你可以弃置一张牌，令一名敌方角色选择一项：1.弃置一张牌；2.你摸一张牌。
  
  **攻其不备**：
  - 蜀势力技能〖连营〗：当你失去手牌后，若你没有手牌，你可以摸一张牌。
  - 魏势力技能〖突袭〗：摸牌阶段，你可以改为获得至多两名其他角色的各一张手牌。
  
  **截粮断辎**：
  - 蜀势力技能〖奇谋〗：限定技，出牌阶段，你可以失去X点体力，摸X张牌，本回合内与其他角色计算距离-X且可以多使用X张【杀】。
  - 魏势力技能〖恩怨〗：锁定技，其他角色每令你回复1点体力，该角色摸一张牌；其他角色每对你造成一次伤害，须给你一张<font color='red'>♥</font>手牌，否则该角色失去1点体力。

  **地崩山摧**：
  - 蜀势力技能〖诱言〗：你的回合内，当你的牌因使用或打出之外的方式进入弃牌堆后，你可以从牌堆中获得本次弃牌中没有的花色的牌各一张（出牌阶段、弃牌阶段各限一次）。
  - 魏势力技能〖刚烈〗：当你受到伤害后，你可以进行判定：若结果不为<font color='red'>♥</font>，则伤害来源选择一项：弃置两张手牌，或受到1点伤害。

  **固守城邦**：
  - 蜀势力技能〖仁德〗：出牌阶段，你可以将至少一张手牌任意分配给其他角色。你于本阶段内以此法给出的手牌首次达到两张或更多后，你回复1点体力。
  - 魏势力技能〖焚城〗：限定技，出牌阶段，你可以令所有其他角色依次选择一项：1.弃置至少X+1张牌（X为该角色的上家以此法弃置牌的数量）；2.受到你造成的2点火焰伤害。

  **势如破竹**：
  - 蜀势力技能〖咆哮〗：锁定技，你使用【杀】无次数限制；当你使用的【杀】被抵消后，你本回合下次【杀】造成的伤害+1。
  - 魏势力技能〖夺锐〗：当你于出牌阶段内对一名其他角色造成伤害后，你可以废除你的一个装备栏，然后选择该角色的武将牌上的一个技能（限定技、觉醒技、使命技、主公技除外），令其于其下回合结束之前此技能无效，然后你于其下回合结束或其死亡之前拥有此技能且不能发动〖夺锐〗。

  **出其不意**：
  - 蜀势力技能〖龙胆〗：你可以将【杀】当【闪】、【闪】当【杀】使用或打出。
  - 魏势力技能〖飞军〗：出牌阶段限一次，你可以弃置一张牌，然后选择一项：1.令一名手牌数大于你的角色交给你一张牌；2.令一名装备区里牌数大于你的角色弃置一张装备区里的牌。

  **兵骄将傲**：
  - 蜀势力技能〖奇才〗：锁定技，你使用锦囊牌无距离限制；你装备区的宝物牌和防具牌不能被其他角色弃置。
  - 魏势力技能〖傲才〗：当你于回合外需要使用或打出一张基本牌时，你可以观看牌堆顶的两张牌（若你没有手牌则改为四张），若你观看的牌中有此牌，你可以使用或打出之。

  **两军相持**：
  - 蜀势力技能〖武圣〗：你可以将一张红色牌当【杀】使用或打出。
  - 魏势力技能〖长标〗：出牌阶段限一次，你可将至少一张手牌当【杀】使用（无距离限制），此阶段结束时，若此【杀】造成过伤害，你摸X张牌（X为以此法转化的牌数）。

  **偷渡阴平**：
  - 蜀势力技能〖腹鳞〗：锁定技，你于回合内获得的牌不计入手牌上限。
  - 魏势力技能〖急袭〗：你可以将一张锦囊牌当【顺手牵羊】使用。

  **侧翼迂回**：
  - 蜀势力技能〖狼袭〗：准备阶段，你可以对一名体力值不大于你的其他角色随机造成0~2点伤害。
  - 魏势力技能〖虎骑〗：锁定技，你计算与其他角色的距离-1；当你于回合外受到伤害后，你进行判定，若结果为红色，视为你对伤害来源使用一张【杀】。

  **短兵相接**：
  - 蜀势力技能〖短兵〗：你使用【杀】时可以多选择一名距离为1的角色为目标；你对距离为1的角色使用【杀】需要两张【闪】才能抵消。
  - 魏势力技能〖集智〗：当你使用非转化的普通锦囊牌时，你可以摸一张牌。

  **绝地反击**：
  - 蜀势力技能〖反攻〗：当敌方角色对你使用牌结算后，你可以对其使用一张【杀】。
  - 魏势力技能〖制衡〗：出牌阶段限一次，你可以弃置任意张牌并摸等量的牌。若你以此法弃置了所有的手牌，你多摸一张牌。

  **万夫莫开**：
  - 蜀势力技能〖福佑〗：每回合限一次，当你使用红色普通锦囊牌造成伤害后，你摸一张牌；你使用红色普通锦囊牌额外结算一次。
  - 魏势力技能〖狂骨〗：你对距离1以内的角色造成1点伤害后，你可以选择摸一张牌或回复1点体力。

  **虎视眈眈**：
  - 蜀势力技能〖卫境〗：每轮限一次，当你需要使用【杀】或【闪】时，你可以视为使用之。
  - 魏势力技能〖激昂〗：当你使用【决斗】或红色【杀】指定目标后，或成为【决斗】或红色【杀】的目标后，你可以摸一张牌。

  **逐日不悔**：
  - 蜀势力技能〖武神〗：锁定技，你的<font color='red'>♥</font>手牌视为【杀】；你使用<font color='red'>♥</font>【杀】无距离与次数限制、不计次数且不能被响应。
  - 魏势力技能〖强袭〗：出牌阶段限两次，你可以受到1点伤害或弃置一张武器牌并选择一名于此阶段未选择过的其他角色，你对其造成1点伤害。

  **风云突变**：
  - 蜀势力技能〖逐日〗：你的阶段结束时，若你本阶段手牌数变化过，你可以拼点：若你赢，你可以使用一张拼点牌；若你没赢，你失去1点体力或本技能直到回合结束。
  - 魏势力技能〖熨身〗：出牌阶段各限一次，你可以令一名已受伤的其他角色回复1点体力并选择：1.视为其对你使用冰【杀】；2.视为你对其使用冰【杀】。

  **两军相峙**：
  - 蜀势力技能〖闭境〗：结束阶段，你可以选择至多两张手牌标记为“闭境”。若你于回合外失去“闭境”牌，当前回合角色的弃牌阶段开始时，其需弃置两张牌。准备阶段，你重铸手牌中的“闭境”牌。
  - 魏势力技能〖齐攻〗：当你使用的仅指定唯一目标的【杀】被【闪】抵消后，你可以令一名角色对此目标再使用一张无距离限制的【杀】，此【杀】不可被响应。

  **兵临城下**：
  - 蜀势力技能〖享乐〗：锁定技，当你成为【杀】的目标后，你令使用者选择：1. 弃置一张基本牌；2. 此【杀】对你无效。
  - 魏势力技能〖筑围〗：当你的判定牌生效后，若为【杀】或伤害类锦囊牌，你可以获得之，并令当前回合角色本回合出牌阶段使用【杀】次数和手牌上限+1。
]]

local U = require "packages/utility/utility"

local jiange_getLogic = function()
  local jiange_logic = GameLogic:subclass("jiange_logic") ---@class GameLogic

  function jiange_logic:initialize(room)
    GameLogic.initialize(self, room)
    self.role_table = {
      --{"shu", "shu", "wei", "wei", "wei", "wei", "shu", "shu"},
      {"wei", "wei", "shu", "shu", "shu", "shu", "wei", "wei"},
    }
  end

  function jiange_logic:assignRoles()
    local room = self.room
    local roles = self.role_table[math.random(1, 1)]
    table.shuffle(room.players)
    for i = 1, #room.players do
      local p = room.players[i]
      p.role = roles[i]
      room:setPlayerProperty(p, "role_shown", true)
      room:broadcastProperty(p, "role")
    end
    room:setCurrent(room.players[1])
  end

  function jiange_logic:chooseGenerals()
    local room = self.room
    math.randomseed(tonumber(tostring(os.time()):reverse():sub(1, 6)))
    room:setBanner("@[:]mode_desc", "jiange_short_desc")
    room:setBanner("@[:]jiange_event", "jiange_event"..math.random(1, 19))

    local heroes = {
      ["wei"] = {},
      ["shu"] = {},
    }
    local machines = {
      ["wei"] = {},
      ["shu"] = {},
    }
    for _, general in pairs(Fk.generals) do
      if general.jiange_hero and
        not table.contains(room.disabled_packs, general.package.name) and
        not table.contains(room.disabled_generals, general) then
        table.insert(heroes[general.kingdom], general.name)
      elseif general.jiange_machine and
        not table.contains(room.disabled_packs, general.package.name) and
        not table.contains(room.disabled_generals, general) then
        table.insert(machines[general.kingdom], general.name)
      end
    end
    if #heroes["wei"] == 0 or #heroes["shu"] == 0 or #machines["wei"] == 0 or #machines["shu"] == 0 then
      room:sendLog{
        type = "#NoGeneralDraw",
        toast = true,
      }
      room:gameOver("")
    end

    local ban_list = {
      --变势力类
      "js__xuyou", "js__lvbu", "js__jiangwei", "mou__sunshangxiang", "ol__mengda", "qyt__xiahoushi", "tw__xiahouba",
      --变身类
      "zhaoxiang", "ol__baosanniang", "qyt__jiangwei", "ty__baosanniang",
      --身份类
      "ol__dongzhao", "huanghao",
      --imba
      "zhouxuan", "mou__caopi", "mobile__caomao", "js__guozhao", "ofl__zhonghui",
    }
    local generals = {
      ["wei"] = {},
      ["shu"] = {},
    }
    for _, name in ipairs(room.general_pile) do
      if not table.contains(ban_list, name) then
        local general = Fk.generals[name]
        if general.kingdom == "wei" then
          if general.subkingdom ~= "shu" then
            table.insert(generals["wei"], name)
          else
            table.insert(generals[table.random({"wei", "shu"})], name)
          end
        elseif general.kingdom == "shu" then
          if general.subkingdom ~= "wei" then
            table.insert(generals["shu"], name)
          end
        else
          if general.subkingdom == "wei" or general.subkingdom == "shu" then
            table.insert(generals[general.subkingdom], name)
          end
        end
      end
    end
    room.general_pile = table.simpleClone(generals["wei"])
    table.insertTable(room.general_pile, generals["shu"])
    table.shuffle(room.general_pile)

    local availableGenerals = {
      ["wei"] = table.random(generals["wei"], 2 * room.settings.generalNum),
      ["shu"] = table.random(generals["shu"], 2 * room.settings.generalNum),
    }

    local players = room.players
    local req = Request:new(room.players, "AskForGeneral")
    for i, p in ipairs(players) do
      local arg = {}
      if i % 2 == 1 then --普通武将
        local n = room.settings.generalNum
        while n > 0 do
          table.insert(arg, table.remove(availableGenerals[p.role]))
          n = n - 1
        end
      elseif table.contains({4, 8}, i) then --英魂
        arg = heroes[p.role]
      elseif table.contains({2, 6}, i) then --攻城器械
        arg = machines[p.role]
      end
      if #arg > 0 then
        req:setData(p, { arg, 1, true })
        req:setDefaultReply(p, { arg[1] })
      else
        room:sendLog{
          type = "#NoGeneralDraw",
          toast = true,
        }
        room:gameOver("")
      end
    end
    req:ask()

    local selected = {}
    for _, p in ipairs(players) do
      local general_ret = req:getResult(p)[1]
      room:setPlayerGeneral(p, general_ret, true, true)
      p.general = general_ret
      p.gender = Fk.generals[general_ret].gender
      room:notifyProperty(p, p, "general")
      room:broadcastProperty(p, "gender")
      room:setPlayerProperty(p, "kingdom", p.role)
      table.insertIfNeed(selected, general_ret)
    end
    for _, g in ipairs(selected) do
      room:findGeneral(g)
      table.removeOne(generals["wei"], g)
      table.removeOne(generals["shu"], g)
    end

    if room.settings.enableDeputy then
      availableGenerals = {
        ["wei"] = table.random(generals["wei"], 4 * room.settings.generalNum),
        ["shu"] = table.random(generals["shu"], 4 * room.settings.generalNum),
      }
      for _, p in ipairs(room.players) do
        local arg = {}
        local n = room.settings.generalNum
        while n > 0 do
          table.insert(arg, table.remove(availableGenerals[p.role]))
          n = n - 1
        end
        if #arg > 0 then
          req:setData(p, { arg, 1 })
          req:setDefaultReply(p, { arg[1] })
        else
          room:sendLog{
            type = "#NoGeneralDraw",
            toast = true,
          }
          room:gameOver("")
        end
      end
      req:ask()

      selected = {}
      for _, p in ipairs(players) do
        local general_ret = req:getResult(p)[1]
        room:setDeputyGeneral(p, general_ret)
        table.insertIfNeed(selected, general_ret)
      end
      for _, g in ipairs(selected) do
        room:findGeneral(g)
        table.removeOne(generals["wei"], g)
        table.removeOne(generals["shu"], g)
      end
    end
    for _, p in ipairs(room.players) do
      room:broadcastProperty(p, "general")
    end
    if room.settings.enableDeputy then
      for _, p in ipairs(room.players) do
        room:broadcastProperty(p, "deputyGeneral")
      end
    end
    room:setTag("SkipNormalDeathProcess", true)
  end

  function jiange_logic:attachSkillToPlayers()
    local room = self.room
    local addRoleModSkills = function(player, skillName)
      local skill = Fk.skills[skillName]
      if not skill then
        fk.qCritical("Skill: "..skillName.." doesn't exist!")
        return
      end
      if skill.lordSkill then
        return
      end
      if #skill.attachedKingdom > 0 and not table.contains(skill.attachedKingdom, player.kingdom) then
        return
      end

      room:handleAddLoseSkills(player, skillName, nil, false)
    end
    local jiange_events = {
      {"ol_ex__zhiji", "jiange__weiye"},
      {"liangying", "tuxi"},
      {"ol_ex__qimou", "nos__enyuan"},
      {"youyan", "ganglie"},
      {"rende", "fencheng"},
      {"ex__paoxiao", "duorui"},
      {"longdan", "feijun"},
      {"ex__qicai", "aocai"},
      {"wusheng", "ol_ex__changbiao"},
      {"fulin", "jiange__jixi"},
      {"langxi", "huqi"},
      {"ol__duanbing", "jizhi"},
      {"jiange__fangong", "ex__zhiheng"},
      {"jiange__fuyou", "ol_ex__kuanggu"},
      {"weijing", "jiang"},
      {"ol__wushen", "ol_ex__qiangxi"},
      {"zhuri", "jiange__yushen"},
      {"bijing", "qigong"},
      {"xiangle", "jiange__zhuwei"},
    }
    local skills = jiange_events[tonumber(string.sub(room:getBanner("@[:]jiange_event"), 13))]
    for _, p in ipairs(room.alive_players) do
      for _, s in ipairs(Fk.generals[p.general]:getSkillNameList(false)) do
        addRoleModSkills(p, s)
      end
      if p.deputyGeneral ~= "" then
        for _, s in ipairs(Fk.generals[p.deputyGeneral]:getSkillNameList(false)) do
          addRoleModSkills(p, s)
        end
      end
      if p.role == "shu" then
        room:handleAddLoseSkills(p, skills[1], nil, false)
      else
        room:handleAddLoseSkills(p, skills[2], nil, false)
      end
    end
  end

  return jiange_logic
end

local jiange_rule = fk.CreateTriggerSkill{
  name = "#jiange_rule",
  priority = 0.001,
  mute = true,
  events = { fk.GameOverJudge },
  can_trigger = function (self, event, target, player, data)
    return target == player
  end,
  on_cost = Util.TrueFunc,
  on_use = function(self, event, target, player, data)
    local room = player.room
    if event == fk.GameOverJudge then
      room:setTag("SkipGameRule", true)
      if not table.find(room.players, function(p)
        return (p.rest > 0 or not p.dead) and p ~= player and p.role == player.role
      end) then
        room:gameOver(room.alive_players[1].role)
        return true
      end
    end
  end,
}
Fk:addSkill(jiange_rule)

local jiange_mode = fk.CreateGameMode{
  name = "jiange_mode",
  minPlayer = 8,
  maxPlayer = 8,
  logic = jiange_getLogic,
  rule = jiange_rule,
  surrender_func = function(self, playedTime)
    local canSurrender = true
    if table.find(Fk:currentRoom().players, function(p)
      return (p.rest > 0 or not p.dead) and p ~= Self and p.role == Self.role
    end) then
      canSurrender = false
    end
    return { { text = "jiange_surrender", passed = canSurrender } }
  end,
  winner_getter = function(self, victim)
    if not victim.surrendered and victim.rest > 0 then
      return ""
    end
    local room = victim.room
    local alive = table.filter(room.players, function(p) ---@type Player[]
      return not p.surrendered and not (p.dead and p.rest == 0)
    end)
    local winner = alive[1].role
    for _, p in ipairs(alive) do
      if p.role ~= winner then
        return ""
      end
    end
    return winner
  end,
}

Fk:loadTranslationTable{
  ["jiange_mode"] = "守卫剑阁",
  [":jiange_mode"] = jiange_desc,
  ["jiange_surrender"] = "本阵营仅剩你存活",
  ["@[:]jiange_event"] = "事件",

  ["jiange_short_desc"] = "守卫剑阁",
  [":jiange_short_desc"] = "◆本模式为魏蜀双势力对抗，获胜条件为消灭所有敌方势力角色。"
  .."<br>◆行动顺序为：魏势力武将-魏势力攻城器械-蜀势力武将-蜀势力英魂-蜀势力武将-蜀势力攻城器械-蜀势力武将-魏势力英魂"
  .."<br>◆游戏开始前会随机发生一个事件，所有角色根据势力获取对应事件的技能。"
  .."<br>◆杀死角色没有奖惩！",

  ["jiange_event1"] = "百步九折",
  [":jiange_event1"] = "蜀势力角色获得〖志继〗，魏势力角色获得〖魏业〗<br>"..
  "<font color='red'>〖志继〗</font>准备阶段或结束阶段，若你没有手牌，你回复1点体力或摸两张牌，减1点体力上限并获得技能〖观星〗。<br>"..
  "<font color='blue'>〖魏业〗</font>准备阶段，你可以弃置一张牌，令一名敌方角色选择一项：1.弃置一张牌；2.你摸一张牌。",

  ["jiange_event2"] = "攻其不备",
  [":jiange_event2"] = "蜀势力角色获得〖连营〗，魏势力角色获得〖突袭〗<br>"..
  "<font color='red'>〖连营〗</font>当你失去手牌后，若你没有手牌，你可以摸一张牌。<br>"..
  "<font color='blue'>〖突袭〗</font>摸牌阶段，你可以改为获得至多两名其他角色的各一张手牌。",

  ["jiange_event3"] = "截粮断辎",
  [":jiange_event3"] = "蜀势力角色获得〖奇谋〗，魏势力角色获得〖恩怨〗<br>"..
  "<font color='red'>〖奇谋〗</font>限定技，出牌阶段，你可以失去X点体力，摸X张牌，本回合内与其他角色计算距离-X且可以多使用X张【杀】。<br>"..
  "<font color='blue'>〖恩怨〗</font>锁定技，其他角色每令你回复1点体力，该角色摸一张牌；其他角色每对你造成一次伤害，须给你一张<font color='red'>♥</font>手牌，否则该角色失去1点体力。",

  ["jiange_event4"] = "地崩山摧",
  [":jiange_event4"] = "蜀势力角色获得〖诱言〗，魏势力角色获得〖刚烈〗<br>"..
  "<font color='red'>〖诱言〗</font>你的回合内，当你的牌因使用或打出之外的方式进入弃牌堆后，你可以从牌堆中获得本次弃牌中没有的花色的牌各一张（出牌阶段、弃牌阶段各限一次）。<br>"..
  "<font color='blue'>〖刚烈〗</font>当你受到伤害后，你可以进行判定：若结果不为<font color='red'>♥</font>，则伤害来源选择一项：弃置两张手牌，或受到1点伤害。",

  ["jiange_event5"] = "固守城邦",
  [":jiange_event5"] = "蜀势力角色获得〖仁德〗，魏势力角色获得〖焚城〗<br>"..
  "<font color='red'>〖仁德〗</font>出牌阶段，你可以将至少一张手牌任意分配给其他角色。你于本阶段内以此法给出的手牌首次达到两张或更多后，你回复1点体力。<br>"..
  "<font color='blue'>〖焚城〗</font>限定技，出牌阶段，你可以令所有其他角色依次选择一项：1.弃置至少X+1张牌（X为该角色的上家以此法弃置牌的数量）；2.受到你造成的2点火焰伤害。",

  ["jiange_event6"] = "势如破竹",
  [":jiange_event6"] = "蜀势力角色获得〖咆哮〗，魏势力角色获得〖夺锐〗<br>"..
  "<font color='red'>〖咆哮〗</font>锁定技，你使用【杀】无次数限制；当你使用的【杀】被抵消后，你本回合下次【杀】造成的伤害+1。<br>"..
  "<font color='blue'>〖夺锐〗</font>当你于出牌阶段内对一名其他角色造成伤害后，你可以废除你的一个装备栏，然后选择该角色的武将牌上的一个技能（限定技、觉醒技、使命技、主公技除外），令其于其下回合结束之前此技能无效，然后你于其下回合结束或其死亡之前拥有此技能且不能发动〖夺锐〗。",

  ["jiange_event7"] = "出其不意",
  [":jiange_event7"] = "蜀势力角色获得〖龙胆〗，魏势力角色获得〖飞军〗<br>"..
  "<font color='red'>〖龙胆〗</font>你可以将【杀】当【闪】、【闪】当【杀】使用或打出。<br>"..
  "<font color='blue'>〖飞军〗</font>出牌阶段限一次，你可以弃置一张牌，然后选择一项：1.令一名手牌数大于你的角色交给你一张牌；2.令一名装备区里牌数大于你的角色弃置一张装备区里的牌。",

  ["jiange_event8"] = "兵骄将傲",
  [":jiange_event8"] = "蜀势力角色获得〖奇才〗，魏势力角色获得〖傲才〗<br>"..
  "<font color='red'>〖奇才〗</font>锁定技，你使用锦囊牌无距离限制；你装备区的宝物牌和防具牌不能被其他角色弃置。<br>"..
  "<font color='blue'>〖傲才〗</font>当你于回合外需要使用或打出一张基本牌时，你可以观看牌堆顶的两张牌（若你没有手牌则改为四张），若你观看的牌中有此牌，你可以使用或打出之。",

  ["jiange_event9"] = "两军相持",
  [":jiange_event9"] = "蜀势力角色获得〖武圣〗，魏势力角色获得〖长标〗<br>"..
  "<font color='red'>〖武圣〗</font>你可以将一张红色牌当【杀】使用或打出。<br>"..
  "<font color='blue'>〖长标〗</font>出牌阶段限一次，你可将至少一张手牌当【杀】使用（无距离限制），此阶段结束时，若此【杀】造成过伤害，你摸X张牌（X为以此法转化的牌数）。",

  ["jiange_event10"] = "偷渡阴平",
  [":jiange_event10"] = "蜀势力角色获得〖腹鳞〗，魏势力角色获得〖急袭〗<br>"..
  "<font color='red'>〖腹鳞〗</font>锁定技，你于回合内获得的牌不计入手牌上限。<br>"..
  "<font color='blue'>〖急袭〗</font>你可以将一张锦囊牌当【顺手牵羊】使用。",

  ["jiange_event11"] = "侧翼迂回",
  [":jiange_event11"] = "蜀势力角色获得〖狼袭〗，魏势力角色获得〖虎骑〗<br>"..
  "<font color='red'>〖狼袭〗</font>准备阶段，你可以对一名体力值不大于你的其他角色随机造成0~2点伤害。<br>"..
  "<font color='blue'>〖虎骑〗</font>锁定技，你计算与其他角色的距离-1；当你于回合外受到伤害后，你进行判定，若结果为红色，视为你对伤害来源使用一张【杀】。",

  ["jiange_event12"] = "短兵相接",
  [":jiange_event12"] = "蜀势力角色获得〖短兵〗，魏势力角色获得〖集智〗<br>"..
  "<font color='red'>〖短兵〗</font>你使用【杀】时可以多选择一名距离为1的角色为目标；你对距离为1的角色使用【杀】需要两张【闪】才能抵消。<br>"..
  "<font color='blue'>〖集智〗</font>当你使用非转化的普通锦囊牌时，你可以摸一张牌。",

  ["jiange_event13"] = "绝地反击",
  [":jiange_event13"] = "蜀势力角色获得〖反攻〗，魏势力角色获得〖制衡〗<br>"..
  "<font color='red'>〖反攻〗</font>当敌方角色对你使用牌结算后，你可以对其使用一张【杀】。<br>"..
  "<font color='blue'>〖制衡〗</font>出牌阶段限一次，你可以弃置任意张牌并摸等量的牌。若你以此法弃置了所有的手牌，你多摸一张牌。",

  ["jiange_event14"] = "万夫莫开",
  [":jiange_event14"] = "蜀势力角色获得〖福佑〗，魏势力角色获得〖狂骨〗<br>"..
  "<font color='red'>〖福佑〗</font>每回合限一次，当你使用红色普通锦囊牌造成伤害后，你摸一张牌；你使用红色普通锦囊牌额外结算一次。<br>"..
  "<font color='blue'>〖狂骨〗</font>你对距离1以内的角色造成1点伤害后，你可以选择摸一张牌或回复1点体力。",

  ["jiange_event15"] = "虎视眈眈",
  [":jiange_event15"] = "蜀势力角色获得〖卫境〗，魏势力角色获得〖激昂〗<br>"..
  "<font color='red'>〖卫境〗</font>每轮限一次，当你需要使用【杀】或【闪】时，你可以视为使用之。<br>"..
  "<font color='blue'>〖激昂〗</font>当你使用【决斗】或红色【杀】指定目标后，或成为【决斗】或红色【杀】的目标后，你可以摸一张牌。",

  ["jiange_event16"] = "逐日不悔",
  [":jiange_event16"] = "蜀势力角色获得〖武神〗，魏势力角色获得〖强袭〗<br>"..
  "<font color='red'>〖武神〗</font>锁定技，你的<font color='red'>♥</font>手牌视为【杀】；你使用<font color='red'>♥</font>【杀】无距离与次数限制、不计次数且不能被响应。<br>"..
  "<font color='blue'>〖强袭〗</font>出牌阶段限两次，你可以受到1点伤害或弃置一张武器牌并选择一名于此阶段未选择过的其他角色，你对其造成1点伤害。",

  ["jiange_event17"] = "风云突变",
  [":jiange_event17"] = "蜀势力角色获得〖逐日〗，魏势力角色获得〖熨身〗<br>"..
  "<font color='red'>〖逐日〗</font>你的阶段结束时，若你本阶段手牌数变化过，你可以拼点：若你赢，你可以使用一张拼点牌；若你没赢，你失去1点体力或本技能直到回合结束。<br>"..
  "<font color='blue'>〖熨身〗</font>出牌阶段各限一次，你可以令一名已受伤的其他角色回复1点体力并选择：1.视为其对你使用冰【杀】；2.视为你对其使用冰【杀】。",

  ["jiange_event18"] = "两军相峙",
  [":jiange_event18"] = "蜀势力角色获得〖闭境〗，魏势力角色获得〖齐攻〗<br>"..
  "<font color='red'>〖闭境〗</font>结束阶段，你可以选择至多两张手牌标记为“闭境”。若你于回合外失去“闭境”牌，当前回合角色的弃牌阶段开始时，其需弃置两张牌。准备阶段，你重铸手牌中的“闭境”牌。<br>"..
  "<font color='blue'>〖齐攻〗</font>当你使用的仅指定唯一目标的【杀】被【闪】抵消后，你可以令一名角色对此目标再使用一张无距离限制的【杀】，此【杀】不可被响应。",

  ["jiange_event19"] = "兵临城下",
  [":jiange_event19"] = "蜀势力角色获得〖享乐〗，魏势力角色获得〖筑围〗<br>"..
  "<font color='red'>〖享乐〗</font>锁定技，当你成为【杀】的目标后，你令使用者选择：1. 弃置一张基本牌；2. 此【杀】对你无效。<br>"..
  "<font color='blue'>〖筑围〗</font>当你的判定牌生效后，若为【杀】或伤害类锦囊牌，你可以获得之，并令当前回合角色本回合出牌阶段使用【杀】次数和手牌上限+1。",
}

local jiange__weiye = fk.CreateTriggerSkill{
  name = "jiange__weiye",
  anim_type = "control",
  events = {fk.EventPhaseStart},
  can_trigger = function(self, event, target, player, data)
    return target == player and player:hasSkill(self) and player.phase == Player.Start and not player:isNude() and
      #U.GetEnemies(player.room, player) > 0
  end,
  on_cost = function (self, event, target, player, data)
    local ids = table.filter(player:getCardIds("he"), function(id) return not player:prohibitDiscard(Fk:getCardById(id)) end)
    local to, card = player.room:askForChooseCardAndPlayers(player, table.map(U.GetEnemies(player.room, player), Util.IdMapper), 1, 1,
      tostring(Exppattern{ id = ids }), "#jiange__weiye-invoke", self.name, true, false)
    if #to == 1 and card then
      self.cost_data = {to[1], card}
      return true
    end
  end,
  on_use = function(self, event, target, player, data)
    local room = player.room
    local to = room:getPlayerById(self.cost_data[1])
    room:throwCard(self.cost_data[2], self.name, player, player)
    if to.dead then return end
    if player.dead then
      room:askForDiscard(to, 1, 1, true, self.name, false)
    else
      if #room:askForDiscard(to, 1, 1, true, self.name, true, nil, "#jiange__weiye-discard:"..player.id) == 0 then
        player:drawCards(1, self.name)
      end
    end
  end,
}
Fk:addSkill(jiange__weiye)

local jiange__jixi = fk.CreateViewAsSkill{
  name = "jiange__jixi",
  anim_type = "control",
  pattern = "snatch",
  prompt = "#jiange__jixi",
  card_filter = function(self, player, to_select, selected)
    return #selected == 0 and Fk:getCardById(to_select).type == Card.TypeTrick
  end,
  before_use = function (self, player)
    player:broadcastSkillInvoke("jixi")
  end,
  view_as = function(self, player, cards)
    if #cards ~= 1 then return end
    local card = Fk:cloneCard("snatch")
    card.skillName = self.name
    card:addSubcard(cards[1])
    return card
  end,
}
Fk:addSkill(jiange__jixi)

local jiange__fangong = fk.CreateTriggerSkill{
  name = "jiange__fangong",
  anim_type = "offensive",
  events = {fk.CardUseFinished},
  can_trigger = function(self, event, target, player, data)
    return player:hasSkill(self) and table.contains(U.GetEnemies(player.room, player), target) and data.tos and
      table.contains(TargetGroup:getRealTargets(data.tos), player.id)
  end,
  on_cost = function (self, event, target, player, data)
    local use = player.room:askForUseCard(player, self.name, "slash", "#jiange__fangong-slash::"..target.id, true,
      {bypass_times = true, bypass_distances = true, extraUse = true, must_targets = {target.id}})
    if use then
      self.cost_data = use
      return true
    end
  end,
  on_use = function(self, event, target, player, data)
    player.room:useCard(self.cost_data)
  end,
}
Fk:addSkill(jiange__fangong)

local jiange__fuyou = fk.CreateTriggerSkill{
  name = "jiange__fuyou",
  mute = true,
  events = {fk.Damage, fk.CardUsing},
  can_trigger = function(self, event, target, player, data)
    if target and target == player and player:hasSkill(self) and data.card and
      data.card:isCommonTrick() and data.card.color == Card.Red then
      if event == fk.Damage then
        return player:getMark("jiange__fuyou-turn") == 0
      else
        return true
      end
    end
  end,
  on_cost = Util.TrueFunc,
  on_use = function(self, event, target, player, data)
    local room = player.room
    player:broadcastSkillInvoke(self.name)
    if event == fk.Damage then
      room:notifySkillInvoked(player, self.name, "drawcard")
      room:setPlayerMark(player, "jiange__fuyou-turn", 1)
      player:drawCards(1, self.name)
    else
      room:notifySkillInvoked(player, self.name, "control")
      data.additionalEffect = (data.additionalEffect or 0) + 1
    end
  end,
}
Fk:addSkill(jiange__fuyou)

local jiange__yushen = fk.CreateActiveSkill{
  name = "jiange__yushen",
  anim_type = "support",
  card_num = 0,
  target_num = 1,
  prompt = function(self)
    return "#jiange__yushen:::"..self.interaction.data
  end,
  interaction = function()
    return UI.ComboBox {
      choices = {"yushen2", "yushen1"}
    }
  end,
  can_use = function(self, player)
    return player:getMark("jiange__yushen_yushen1-phase") == 0 or player:getMark("jiange__yushen_yushen2-phase") == 0
  end,
  card_filter = Util.FalseFunc,
  target_filter = function(self, player, to_select, selected)
    if #selected == 0 and to_select ~= Self.id and Self:getMark("jiange__yushen_"..self.interaction.data.."-phase") == 0 then
      local target = Fk:currentRoom():getPlayerById(to_select)
      if target:isWounded() then
        local slash = Fk:cloneCard("ice__slash")
        slash.skillName = self.name
        if self.interaction.data == "yushen2" then
          return Self:canUseTo(slash, target, { bypass_times = true, bypass_distances = true })
        elseif self.interaction.data == "yushen1" then
          return target:canUseTo(slash, Self, { bypass_times = true, bypass_distances = true })
        end
      end
    end
  end,
  on_use = function(self, room, effect)
    local player = room:getPlayerById(effect.from)
    local target = room:getPlayerById(effect.tos[1])
    player:broadcastSkillInvoke("yushen")
    room:setPlayerMark(player, "jiange__yushen_"..self.interaction.data.."-phase", 1)
    room:recover({
      who = target,
      num = 1,
      recoverBy = player,
      skillName = self.name,
    })
    if self.interaction.data == "yushen1" then
      if not player.dead then
        room:useVirtualCard("ice__slash", nil, target, player, self.name, true)
      end
    else
      if not target.dead then
        room:useVirtualCard("ice__slash", nil, player, target, self.name, true)
      end
    end
  end
}
Fk:addSkill(jiange__yushen)

local jiange__zhuwei = fk.CreateTriggerSkill{
  name = "jiange__zhuwei",
  anim_type = "drawcard",
  events = {fk.FinishJudge},
  can_trigger = function(self, event, target, player, data)
    return target == player and player:hasSkill(self) and data.card.is_damage_card and
      player.room:getCardArea(data.card) == Card.Processing
  end,
  on_cost = function (self, event, target, player, data)
    local room = player.room
    self.cost_data = nil
    local prompt = "#jiange__zhuwei1-invoke:::"..data.card:toLogString()
    local turn_event = room.logic:getCurrentEvent():findParent(GameEvent.Turn)
    if turn_event then
      local to = turn_event.data[1]
      if not to.dead then
        prompt = "#jiange__zhuwei2-invoke::"..to.id..":"..data.card:toLogString()
        self.cost_data = to
      end
    end
    return room:askForSkillInvoke(player, self.name, nil, prompt)
  end,
  on_use = function(self, event, target, player, data)
    local room = player.room
    room:moveCardTo(data.card, Card.PlayerHand, player, fk.ReasonJustMove, self.name, nil, true, player.id)
    if self.cost_data then
      local to = self.cost_data
      if not to.dead then
        room:doIndicate(player.id, {to.id})
        room:addPlayerMark(to, MarkEnum.SlashResidue.."-turn", 1)
        room:addPlayerMark(to, MarkEnum.AddMaxCardsInTurn, 1)
        room:broadcastProperty(to, "MaxCards")
      end
    end
  end,
}
Fk:addSkill(jiange__zhuwei)
Fk:loadTranslationTable{
  ["jiange__weiye"] = "魏业",
  [":jiange__weiye"] = "准备阶段，你可以弃置一张牌，令一名敌方角色选择一项：1.弃置一张牌；2.你摸一张牌。",
  ["#jiange__weiye-invoke"] = "魏业：你可以弃置一张牌，令一名敌方角色选择弃置一张牌或令你摸一张牌",
  ["#jiange__weiye-discard"] = "魏业：弃置一张牌，否则 %src 摸一张牌",

  ["jiange__jixi"] = "急袭",
  [":jiange__jixi"] = "你可以将一张锦囊牌当【顺手牵羊】使用。",
  ["#jiange__jixi"] = "急袭：你可以将一张锦囊牌当【顺手牵羊】使用",

  ["jiange__fangong"] = "反攻",
  [":jiange__fangong"] = "当敌方角色对你使用牌结算后，你可以对其使用一张【杀】。",
  ["#jiange__fangong-slash"] = "反攻：你可以对 %dest 使用一张【杀】",

  ["jiange__fuyou"] = "福佑",
  [":jiange__fuyou"] = "每回合限一次，当你使用红色普通锦囊牌造成伤害后，你摸一张牌；你使用红色普通锦囊牌额外结算一次。",

  ["jiange__yushen"] = "熨身",
  [":jiange__yushen"] = "出牌阶段各限一次，你可以令一名已受伤的其他角色回复1点体力并选择：1.视为其对你使用冰【杀】；2.视为你对其使用冰【杀】。",
  ["#jiange__yushen"] = "熨身：令一名角色回复1点体力，%arg",

  ["jiange__zhuwei"] = "筑围",
  [":jiange__zhuwei"] = "当你的判定牌生效后，若为【杀】或伤害类锦囊牌，你可以获得之，并令当前回合角色本回合出牌阶段使用【杀】次数和手牌上限+1。",
  ["#jiange__zhuwei1-invoke"] = "筑围：是否获得判定牌%arg？",
  ["#jiange__zhuwei2-invoke"] = "筑围：是否获得判定牌%arg，并令 %dest 本回合使用【杀】次数上限和手牌上限+1？",
}

return jiange_mode