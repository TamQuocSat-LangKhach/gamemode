local qixi_desc = [==[
# 新月杀·七夕模式简介

为了顺应七夕节而设计的活动场模式。由4~8人进行游玩。

## 游戏流程

通过随机方式决出一号位。游戏不分发身份，而是直接进入选将环节。

系统选择一半的玩家只抽得到男性武将，另外一半玩家只抽得到女性武将。
如果有奇数个玩家的话那么多出的一名玩家选将框性别随机。

选将完成后，所有角色获得模式专属技能“结伴”。然后系统还会对每个角色都随机抽一个技能发放。

> **结伴**：出牌阶段限一次，若你没有伴侣，你可以将一张
【桃】或者防具交给一名未结伴的异性角色并将其设为追求目标；
然后若其的追求目标是你，双方移除追求目标并结为伴侣。
伴侣确定后就无法更改，即使死亡也无法将二人分开。

当无伴侣的角色造成致命的伤害时，若场上已经没有可以被他追求的角色了，则此伤害+1，
否则防止此伤害。

## 胜负与奖惩

获胜条件为击杀除了自己和伴侣之外的所有其他角色。此外有以下几点奖惩规则：

- 击杀伴侣的角色弃置所有牌并失去一点体力。
- 击杀其他角色的话，自己和伴侣各摸1张牌，伴侣已阵亡则摸2张，从未有过伴侣则摸3张。
- 当伴侣阵亡后，剩余的另一方仍视为结伴状态，且胜负条件不变。

因为没有伴侣就无法击杀其他角色，进而无法获胜，所以尽可能先找好伴侣吧。

（然而春哥除外，唯有情字最伤人啊，把你们都杀了.jpg）

## 特殊奖励

结伴双方失去模式赋予的技能和“结伴”，然后根据男方的势力获得如下技能：

- 魏：【舍身》当伴侣不以此法受到伤害时，你可以将伤害转移给自己。
- 蜀：【共斗》每回合限一次，当伴侣使用的非转化【杀】结算完成后，你可以视为对相同的目标使用一张【杀】。
- 吴：【连枝》使用装备牌后可以令伴侣摸一张牌。
- 群：【泣别》伴侣在求桃结束即将死亡时，你可以将所有体力值和武将牌上的技能交给伴侣（伴侣至少会回复至1点体力），然后阵亡。
- 他：无伴侣技，然而也不失去一开始获得的那个随机技能。

当结伴双方为以下已记录的伴侣时，拥有女伴者获得英姿效果，拥有男伴者获得闭月效果，
同时游戏内显示的“伴侣”标注改为彩色字体。

注意，可以是任何同名武将或者相应名字的神势力武将。

魏晋：

- 曹操 & 除sp夏侯氏外所有女性武将
- 曹丕 & 甄姬/郭照（郭女王）/段巧笑/薛灵芸/田尚衣/莫琼树/刘衿刘佩
- 曹叡 & 郭皇后
- 司马懿 & 张春华/柏灵筠
- 司马昭 & 王元姬
- 司马师 & 夏侯徽/羊徽瑜
- 司马炎 & 杨艳/杨芷/左棻
- 庞德 & 李采薇
- 赵昂 & 王异
- 贾充 & 李婉/郭槐
- 王浑 & 钟琰
- 杜预 & 宣公主
- 钟繇 & 张昌蒲
- 何晏 & 曹金玉
- 庞山民 & 诸葛若雪
- 蒯褀 & 诸葛梦雪
- 曹髦 & 卞玥
- 曹宇 & 张琪瑛
- 夏侯楙 & 清河公主

蜀：

- 刘备 & 甘夫人/糜夫人/孙尚香/张楚？/吴苋
- 张飞 & 夏侯氏
- 关羽 & 胡金定
- 孟获 & 祝融
- 刘禅 & 星彩/张瑾云
- 诸葛亮/卧龙 & 黄月英
- 黄忠 & 刘赪
- 马超 & 杨婉
- 赵云 & 马云禄/周夷/樊玉凤
- 关索 & 鲍三娘/王桃/王悦/花鬘
- 刘理 & 马伶俐
- 姜维 & 柳婒/文鸳

吴：

- 孙权 & 步练师/袁姬/潘淑/谢灵毓/赵嫣/徐馨
- 周瑜 & 小乔
- 孙策 & 大乔
- 孙坚 & 吴国太/吴珂
- 孙皓 & 滕芳兰/张媱/张嫙
- 陆逊 & 孙茹
- 孙登 & 芮姬/周妃
- 张奋 & 孙翎鸾
- 滕胤 & 滕公主
- 孙翊 & 徐氏
- 全琮 & 孙鲁班
- 孙亮 & 全惠解
- 孙休 & 朱佩兰
- 陆抗 & 张怀

群：

- 吕布 & 严夫人/貂蝉/曹媛
- 董卓 & 貂蝉 （极其存疑）
- 刘协 & 伏皇后/曹节/曹宪/曹华/董贵人
- 刘宏 & 何太后/王荣/宋皇后
- 刘辩 & 唐姬
- 刘表 & 蔡夫人
- 张济 & 邹氏
- 袁绍 & 刘夫人
- 袁术 & 冯方女/董绾
- 牛辅 & 董翓
- 秦宜禄 & 杜夫人

其他：

- 女士兵 & 男士兵
- 张角 & 黄巾雷使
- 刘焉 & 卢氏
- 吕不韦 & 赵姬

]==]

---@param player ServerPlayer
local function attachRandomSkill(player)
  local generals = Fk:getGeneralsRandomly(3, nil, { player.general })
  for _, g in ipairs(generals) do
    for _, s in ipairs(g:getSkillNameList(false)) do
      if not player:hasSkill(s) then
        player.tag["qixi_rand_skill"] = s
        player.room:handleAddLoseSkills(player, s)
        return
      end
    end
  end
end

local qixi_get_logic = function()
  ----@class qixi_logic : GameLogic
  local qixi_logic = GameLogic:subclass("qixi_logic")

  function qixi_logic:assignRoles()
    local room = self.room ---@type Room
    local n = #room.players
    local half = n // 2
    local t = {}
    for _ = 1, half do
      table.insert(t, "@!qixi_male")
      table.insert(t, "@!qixi_female")
    end
    if #t < n then
      table.insert(t, table.random{ "@!qixi_male", "@!qixi_female" })
    end
    table.shuffle(t)

    for i, p in ipairs(room.players) do
      room:addPlayerMark(p, t[i])
      room:setPlayerProperty(p, "role", "hidden")
      room:setPlayerProperty(p, "role_shown", true)
    end

    -- for adjustSeats
    room.players[1].role = "lord"
  end

  function qixi_logic:chooseGenerals()
    local room = self.room --- @type Room
    local nonlord = room.players

    local males, females = {}, {}
    for _, p in ipairs(nonlord) do
      if p:getMark("@!qixi_male") > 0 then
        table.insert(males, p)
      else
        table.insert(females, p)
      end
    end

    local male_generals,female_generals = {}, {}

    for _, gname in ipairs(room.general_pile) do
      local general = Fk.generals[gname]
      if general.gender == General.Male then
        table.insert(male_generals, gname)
      elseif general.gender == General.Female then
        table.insert(female_generals, gname)
      end
      -- no Bigender & Agender
    end
    local generalNum = math.min(room.settings.generalNum, #male_generals // #males, #female_generals // #females)
    if generalNum < 3 then
      room:sendLog{ type = "#NoGeneralDraw", toast = true }
      room:gameOver("")
    end

    local n = room.settings.enableDeputy and 2 or 1
    local lord = room:getLord()
    room:setCurrent(lord)
    lord.role = "hidden"

    for _, p in ipairs(nonlord) do
      room:setPlayerMark(p, "@seat", "seat#"..p.seat)
    end

    local req = Request:new(nonlord, "AskForGeneral")
    for i, p in ipairs(nonlord) do
      local arg = {}
      local t = (p:getMark("@!qixi_female") > 0) and female_generals or male_generals
      for _ = 1, generalNum do
        table.insert(arg, table.remove(t))
      end
      req:setData(p, { arg, n })
      req:setDefaultReply(p, table.random(arg, n))
    end

    for _, p in ipairs(nonlord) do
      local result = req:getResult(p)
      local general, deputy = result[1], result[2]
      room:findGeneral(general)
      room:findGeneral(deputy)
      room:prepareGeneral(p, general, deputy)
    end

    for _, p in ipairs(nonlord) do
      room:setPlayerMark(p, "@seat", 0)
    end

    room:askToChooseKingdom(nonlord)

    room:setBanner("@[:]mode_desc", "qixi_short_desc")
  end

  function qixi_logic:attachSkillToPlayers()
    GameLogic.attachSkillToPlayers(self)
    local room = self.room
    for _, p in ipairs(room.players) do
      room:handleAddLoseSkills(p, "qixi_jieban&")
      attachRandomSkill(p)
    end
    room:addSkill(Fk.skills["#qixi_rule&"])
  end

  return qixi_logic
end

local qixi_mode = fk.CreateGameMode{
  name = "qixi_mode",
  minPlayer = 4,
  maxPlayer = 8,
  logic = qixi_get_logic,
  rule = Fk.skills["#qixi_rule&"] --[[@as TriggerSkill]],
  winner_getter = function(self, victim)
    local winner = "renegade"
    if not victim.surrendered and victim.rest > 0 then
      winner = ""
    end
    local room = victim.room
    if winner ~= "" then
      local alive = table.filter(room.players, function(p)
        return not p.surrendered and not (p.dead and p.rest == 0)
      end)
      if #alive > 2 then
        winner = ""
      end
      if #alive == 1 then
        winner = "renegade"
      else
        if alive[1]:getMark("qixi_couple") == alive[2].id then
          winner = "renegade"
        else
          winner = ""
        end
      end
    end
    if winner ~= "" then
      local alive = table.filter(room.alive_players, function(p)
        return not p.surrendered
      end)
      local p = alive[1]
      room:setPlayerProperty(p, "role", "renegade")
      local c = room:getPlayerById(p:getMark("qixi_couple"))
      if c then
        room:setPlayerProperty(c, "role", "renegade")
      end
      room:gameOver(winner)
    end
    return winner
  end,
  surrender_func = function(self, playedTime)
    local room = Fk:currentRoom()
    local canSurrender = true
    local coupleId = Self:getMark("qixi_couple")
    if coupleId ~= 0 then
      local couple = room:getPlayerById(coupleId)
      if couple and (couple.rest > 0 or not couple.dead) then
        canSurrender = false
      end
    end
    if canSurrender then
      ---@type ClientPlayer[]
      local others = table.filter(Fk:currentRoom().players, function(p)
        return (p.rest > 0 or not p.dead) and p ~= Self and p.id ~= coupleId
      end)
      if #others > 2 then
        canSurrender = false
      elseif #others == 2 then
        if others[1]:getMark("qixi_couple") ~= others[2].id and others[1]:getMark("qixi_couple") ~= others[2].id then
          canSurrender = false
        end
      end
    end
    return { { text = "qixi_surrender", passed = canSurrender } }
  end,
  reward_punish = function (self, victim, killer)
    local room = victim.room
    if killer and not killer.dead then
      local c = killer:getMark("qixi_couple")
      if victim.id == c then
        killer:throwAllCards("he")
        room:loseHp(killer, 1, "#qixi_rule")
      else
        local couple = room:getPlayerById(c)
        if couple then
          if not couple.dead then
            killer:drawCards(1, "#qixi_rule")
            couple:drawCards(1, "#qixi_rule")
          else
            killer:drawCards(2, "#qixi_rule")
          end
        else
          killer:drawCards(3, "#qixi_rule")
        end
      end
    end
  end,
  friend_enemy_judge = function (self, targetOne, targetTwo)
    return targetOne:getMark("qixi_couple") == targetTwo.id or targetTwo:getMark("qixi_couple") == targetOne.id
  end,
}

Fk:loadTranslationTable{
  ["qixi_mode"] = "七夕模式",
  [":qixi_mode"] = qixi_desc,

  ["#qixi_rule"] = "七夕规则",
  ["@qixi_pay_court"] = "追求",
  ["@qixi_couple"] = "伴侣",
  ["@qixi_couple_blue"] = "<font color='#87CEFA'>伴侣</font>",
  ["@qixi_couple_pink"] = "<font color='#FFB6C1'>伴侣</font>",
  ["qixi_surrender"] = "未结伴或伴侣已死亡，且仅剩一名其他角色或一对其他伴侣",

  ["@[:]mode_desc"] = "模式简介",
  ["qixi_short_desc"] = "七夕",
  [":qixi_short_desc"] = "◆获胜条件为击杀除了自己和伴侣之外的所有其他角色。"
  .."<br>◆所有角色拥有模式专属技能“结伴”，以及一个随机技能"
  .."<br>◆发动技能“结伴”追求异性，互相发动“结伴”后即结为伴侣。"
  .."<br>◆当无伴侣的角色造成致命伤害时，若场上没有可以被追求的角色，则伤害+1，否则防止伤害。"
  .."<br>◆击杀伴侣的角色弃置所有牌并失去一点体力。"
  .."<br>◆击杀非伴侣角色，自己和伴侣各摸牌。"
  .."<br>"
  .."<br>结伴后，双方失去模式赋予的技能和“结伴”，然后根据男方的势力获得如下技能："
  .."<br>   魏：【舍身》当伴侣不以此法受到伤害时，你可以将伤害转移给自己。"
  .."<br>   蜀：【共斗》每回合限一次，当伴侣使用的非转化【杀】结算完成后，你可以视为对相同的目标使用一张【杀】。"
  .."<br>   吴：【连枝》当你使用装备牌时，可以令伴侣摸一张牌。"
  .."<br>   群：【泣别》伴侣在求桃结束即将死亡时，你可以将所有体力值和武将牌上的技能交给伴侣（伴侣至少会回复至1点体力），然后阵亡。"
  .."<br>   其他：不会得到伴侣技，但也不失去模式赋予的那个技能。"
  .."<br>"
  .."<br>特别的，当原配夫妻（例如周瑜&小乔）结伴时，男方获得“英姿”效果，女方获得“闭月”效果（不显示，无法被无效，锁定发动，标的）",
}

return qixi_mode
