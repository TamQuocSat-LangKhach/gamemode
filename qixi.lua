local qixi_desc = [==[
# 新月杀·七夕模式简介

为了顺应七夕节而设计的活动场模式。由4~8人进行游玩。

## 游戏流程

通过随机方式决出一号位。游戏不分发身份，而是直接进入选将环节。

系统选择一半的玩家只抽得到男性武将，另外一半玩家只抽得到女性武将。
如果有奇数个玩家的话那么多出的一名玩家选将框性别随机。

选将完成后，所有角色获得模式专属技能“结伴”。然后系统还会对每个角色都随机抽一个技能发放。

> **结伴**：出牌阶段限一次，若你没有伴侣，你可以将一张
【桃】或者防具交给一名未结伴的异性角色并将其设为追求目标；
然后若其的追求目标是你，双方移除追求目标并结为伴侣。
伴侣确定后就无法更改，即使死亡也无法将二人分开。

当无伴侣的角色造成致命的伤害时，若场上已经没有可以被他追求的角色了，则此伤害+1，
否则防止此伤害。

## 胜负与奖惩

获胜条件为击杀除了自己和伴侣之外的所有其他角色。此外有以下几点奖惩规则：

- 击杀伴侣的角色弃置所有牌并失去一点体力。
- 击杀其他角色的话，自己和伴侣各摸1张牌，伴侣已阵亡则摸2张，从未有过伴侣则摸3张。
- 当伴侣阵亡后，剩余的另一方仍视为结伴状态，且胜负条件不变。

因为没有伴侣就无法击杀其他角色，进而无法获胜，所以尽可能先找好伴侣吧。

（然而春哥除外，唯有情字最伤人啊，把你们都杀了.jpg）

## 特殊奖励

结伴双方失去模式赋予的技能和“结伴”，然后根据男方的势力获得如下技能：

- 魏：【舍身》当伴侣不以此法受到伤害时，你可以将伤害转移给自己。
- 蜀：【共斗》每回合限一次，当伴侣使用的非转化【杀】结算完成后，你可以视为对相同的目标使用一张【杀】。
- 吴：【连枝》使用装备牌后可以令伴侣摸一张牌。
- 群：【泣别》伴侣在求桃结束即将死亡时，你可以将所有体力值和武将牌上的技能交给伴侣（伴侣至少会回复至1点体力），然后阵亡。
- 他：无伴侣技，然而也不失去一开始获得的那个随机技能。

当结伴双方为以下已记录的伴侣时，拥有女伴者获得英姿效果，拥有男伴者获得闭月效果，
同时游戏内显示的“伴侣”标注改为彩色字体。

注意，可以是任何同名武将或者相应名字的神势力武将。

魏晋：

- 曹操 & 除sp夏侯氏外所有女性武将
- 曹丕 & 甄姬/郭照/段巧笑/薛灵芸/田尚衣
- 曹叡 & 郭皇后
- 司马懿 & 张春华/柏灵筠
- 司马昭 & 王元姬
- 司马师 & 夏侯徽/羊徽瑜
- 司马炎 & 杨艳/杨芷/左棻
- 庞德 & 李采薇
- 赵昂 & 王异
- 贾充 & 李婉/郭槐
- 王浑 & 钟琰
- 杜预 & 宣公主
- 钟繇 & 张昌蒲
- 何晏 & 曹金玉
- 庞山民 & 诸葛若雪
- 蒯褀 & 诸葛梦雪
- 曹髦 & 卞玥
- 曹宇 & 张琪瑛
- 夏侯楙 & 清河公主

蜀：

- 刘备 & 甘夫人/糜夫人/孙尚香/张楚/吴苋
- 张飞 & 夏侯氏
- 关羽 & 胡金定
- 孟获 & 祝融
- 刘禅 & 星彩/张瑾云
- 诸葛亮/卧龙 & 黄月英
- 黄忠 & 刘赪
- 马超 & 杨婉
- 赵云 & 马云禄/周夷/樊玉凤
- 关索 & 鲍三娘/王桃/王悦/花鬘
- 刘理 & 马伶俐
- 姜维 & 柳婒

吴：

- 孙权 & 步练师/袁姬/潘淑/谢灵毓/赵嫣
- 周瑜 & 小乔
- 孙策 & 大乔
- 孙坚 & 吴国太
- 孙皓 & 滕芳兰/张媱/张嫙
- 陆逊 & 孙茹
- 孙登 & 芮姬/周妃
- 张奋 & 孙翎鸾
- 滕胤 & 滕公主
- 孙翊 & 徐氏
- 全琮 & 孙鲁班
- 孙亮 & 全惠解
- 孙休 & 朱佩兰

群：

- 吕布 & 严夫人/貂蝉
- 董卓 & 貂蝉 （极其存疑）
- 刘协 & 伏皇后/曹节/曹宪曹华/曹华/董贵人
- 刘宏 & 何太后/王荣
- 刘辩 & 唐姬
- 刘表 & 蔡夫人
- 张济 & 邹氏
- 袁绍 & 刘夫人
- 袁术 & 冯方女/董绾
- 牛辅 & 董翓
- 秦宜禄 & 杜夫人

其他：

- 女士兵 & 男士兵
- 张角 & 黄巾雷使
- 刘焉 & 卢氏
- 吕不韦 & 赵姬

]==]

local U = require "packages/utility/utility"

local couples = {
  -- wei
  caopi = { "zhenji", "guozhao", "duanqiaoxiao", "xuelingyun", "tianshangyi" },
  caorui = "guohuanghou",
  simayi = {"zhangchunhua", "bailingyun"},
  simazhao = "wangyuanji",
  simashi = { "xiahouhui", "yanghuiyu" },
  simayan = { "yangyan", "yangzhi", "zuofen" },
  pangde = "licaiwei",
  zhaoang = "wangyi",
  jiachong = { "liwan", "guohuaij" },
  wanghun = "zhongyan",
  duyu = "xuangongzhu",
  zhongyao = "zhangchangpu",
  heyan = "caojinyu",
  pangshanmin = "zhugeruoxue",
  kuaiqi = "zhugemengxue",
  caomao = "bianyue",
  caoyu = "zhangqiying",
  xiahoumao = "qinghegongzhu",

  -- shu
  liubei = { "ganfuren", "mifuren", "sunshangxiang", "zhangchu", "wuxian", "ganfurenmifuren" },
  zhangfei = "xiahoushi",
  guanyu = "hujinding",
  menghuo = "zhurong",
  liushan = { "xingcai", "zhangjinyun" },
  zhugeliang = "huangyueying",
  wolong = "huangyueying",
  huangzhong = "liucheng",
  machao = "yangwan",
  zhaoyun = {"mayunlu", "zhouyi", "fanyufeng"}, -- 绷
  guansuo = { "baosanniang", "wangtao", "wangyues", "huaman" },
  liuliG = "malingli",
  jiangwei = "liutan",

  -- wu
  sunquan = { "bulianshi", "yuanji", "panshu", "xielingyu", "zhaoyanw" },
  zhouyu = "xiaoqiao",
  sunce = "daqiao",
  sunjian = "wuguotai",
  sunhao = { "tengfanglan", "zhangxuan", "zhangyao" },  -- 太哈人了
  luxun = "sunru",
  sundeng = { "ruiji", "zhoufei" },
  zhangfen = "sunlingluan",
  tengyin = "tenggongzhu",
  sunyi = "xushi",
  quancong = "sunluban",
  sunliang = "quanhuijie",
  sunxiu = "zhupeilan",

  -- qun
  lvbu = { "diaochan", "yanfuren" },
  dongzhuo = "diaochan",  -- ???
  liuxie = { "fuhuanghou", "caojie", "caoxiancaohua", "caohua", "dongguiren" },
  liubiao = "caifuren",
  liuhong = { "hetaihou", "wangrong" },
  liubian = "tangji",
  zhangji = "zoushi",
  yuanshao = "liufuren",
  yuanshu = {"fengfangnv", "dongwan"},
  niufu = "dongxie",
  qinyilu = "dufuren",

  -- misc
  blank_shibing = "blank_nvshibing",
  zhangjiao = "huangjinleishi",
  liuyan = "lushi",
  lvbuwei = "zhaoji",
}

---@param from ServerPlayer
---@param to ServerPlayer
local function isCoupleGeneral(from, to)
  local m, f = from, to
  if from.gender == General.Female then
    m, f = to, from
  end
  local g1 = Fk.generals[m.general].trueName
  local g2 = Fk.generals[f.general].trueName
  if g1:startsWith("god") then g1 = g1:sub(4) end
  if g2:startsWith("god") then g2 = g2:sub(4) end
  if g1 == "caocao" and f.general ~= "sp__xiahoushi" then return true end
  local t = couples[g1] or ""
  return t == g2 or (type(t) == "table" and table.contains(t, g2))
end

---@param from ServerPlayer
---@param to ServerPlayer
local function isCouple(from, to)
  return from:getMark("qixi_couple") == to.id and to:getMark("qixi_couple") == from.id
end

---@param player ServerPlayer
local function attachRandomSkill(player)
  local generals = Fk:getGeneralsRandomly(3, nil, { player.general })
  for _, g in ipairs(generals) do
    for _, s in ipairs(g:getSkillNameList(false)) do
      if not player:hasSkill(s) then
        player.tag['qixi_rand_skill'] = s
        player.room:handleAddLoseSkills(player, s)
        return
      end
    end
  end
end

local sheshen = fk.CreateTriggerSkill{
  name = "qixi_sheshen",
  anim_type = "defensive",
  events = { fk.DamageInflicted },
  can_trigger = function(self, event, target, player, data)
    return player:hasSkill(self) and data.skillName ~= self.name and isCouple(target, player)
  end,
  on_use = function(self, event, target, player, data)
    local room = player.room
    room:damage{
      from = data.from,
      to = player,
      damage = data.damage,
      damageType = data.damageType,
      skillName = self.name,
    }
    return true
  end,
}
Fk:addSkill(sheshen)

local gongdou = fk.CreateTriggerSkill{
  name = "qixi_gongdou",
  anim_type = "offensive",
  events = { fk.CardUseFinished },
  can_trigger = function(self, event, target, player, data)
    return player:hasSkill(self) and isCouple(target, player) and
      player:usedSkillTimes(self.name, Player.HistoryTurn) == 0 and
      data.card.trueName == 'slash' and U.isPureCard(data.card)
      and table.find(TargetGroup:getRealTargets(data.tos), function (pid)
        local p = player.room:getPlayerById(pid)
        return not p.dead and player:canUseTo(Fk:cloneCard("slash"), p, {bypass_distances=true,bypass_times=true})
      end)
  end,
  on_use = function(self, event, target, player, data)
    local room = player.room
    local card = Fk:cloneCard('slash')
    card.skillName = self.name
    local targets = table.filter(TargetGroup:getRealTargets(data.tos), function (pid)
      local p = room:getPlayerById(pid)
      return not p.dead and player:canUseTo(card, p, {bypass_distances=true,bypass_times=true})
    end)
    room:useCard{
      from = player.id,
      card = card,
      tos = table.map(targets, function(p) return {p} end),
      extraUse = true,
    }
  end,
}
Fk:addSkill(gongdou)

local lianzhi = fk.CreateTriggerSkill{
  name = 'qixi_lianzhi',
  anim_type = 'drawcard',
  events = { fk.CardUsing },
  can_trigger = function(self, event, target, player, data)
    return target == player and player:hasSkill(self) and data.card.type == Card.TypeEquip and
      player.room:getPlayerById(player:getMark('qixi_couple')) ~= nil
      and not player.room:getPlayerById(player:getMark('qixi_couple')).dead
  end,
  on_use = function(self, event, target, player, data)
    player.room:getPlayerById(player:getMark('qixi_couple')):drawCards(1, self.name)
  end,
}
Fk:addSkill(lianzhi)

local qibie = fk.CreateTriggerSkill{
  name = 'qixi_qibie',
  anim_type = 'big',
  events = { fk.AskForPeachesDone },
  can_trigger = function(self, event, target, player, data)
    return player:hasSkill(self) and isCouple(target, player) and
      target.hp < 1
  end,
  on_use = function(self, event, target, player, data)
    local room = player.room
    local skills = Fk.generals[player.general]:getSkillNameList()
    table.insert(skills, '-qixi_qibie')
    room:handleAddLoseSkills(target, table.concat(skills, '|'))
    room:recover {
      who = target,
      num = math.max(player.hp, 1 - target.hp),
      skillName = self.name,
    }

    local skills2 = table.map(player:getAllSkills(), function(s)
      return "-" .. s.name
    end)
    room:handleAddLoseSkills(player, table.concat(skills2, '|'))
    room:loseHp(player, player.hp, self.name)
  end,
}

Fk:addSkill(qibie)

Fk:loadTranslationTable{
  ['qixi_sheshen'] = '舍身',
  [':qixi_sheshen'] = '伴侣技，当伴侣不以此法受到伤害时，你可以将伤害转移给自己。',
  ['qixi_gongdou'] = '共斗',
  [':qixi_gongdou'] = '伴侣技，一回合一次，当伴侣使用的非转化杀结算结束后，你可以视为对相同的目标使用了一张【杀】。',
  ['qixi_lianzhi'] = '连枝',
  [':qixi_lianzhi'] = '伴侣技，你使用装备牌时，可以令伴侣摸一张牌。',
  ['qixi_qibie'] = '泣别',
  [':qixi_qibie'] = '伴侣技，当伴侣求桃结束即将阵亡时，你可以令其失去“泣别”，获得你武将牌上所有的技能并回复X点体力' ..
    '（X为你的体力值且至少能令其回复至1点体力），然后你失去所有技能和所有体力。',
}

---@param from ServerPlayer
---@param to ServerPlayer
local function addCoupleSkill(from, to)
  local room = from.room
  local kingdom = from.gender == General.Male and from.kingdom or to.kingdom
  local kingdom_skill_map = {
    ["wei"] = "qixi_sheshen",
    ["shu"] = "qixi_gongdou",
    ["wu"] = "qixi_lianzhi",
    ["qun"] = "qixi_qibie",
  }
  local skill = kingdom_skill_map[kingdom]
  if table.contains({"wei", "shu", "wu", "qun"}, kingdom) then
    room:handleAddLoseSkills(from, skill .. "|-qixi_jieban&|-" .. from.tag['qixi_rand_skill'])
    room:handleAddLoseSkills(to, skill .. "|-qixi_jieban&|-" .. to.tag['qixi_rand_skill'])
  else
    room:handleAddLoseSkills(from, "-qixi_jieban&")
    room:handleAddLoseSkills(to, "-qixi_jieban&")
  end
end

---@param from Player
---@param to Player
local function canPayCourtTo(from, to)
  local room = Fk:currentRoom()
  if from:getMark("qixi_couple") ~= 0 then return false end
  if to:getMark("qixi_couple") ~= 0 then return false end
  if from:getMark("@!qixi_female") == to:getMark("@!qixi_female") then return false end

  return true
end

local qixi_jieban = fk.CreateActiveSkill{
  name = "qixi_jieban&",
  anim_type = "support",
  can_use = function (self, player, card)
    if player:usedSkillTimes(self.name, Player.HistoryPhase) > 0 then return false end
    if player:getMark("qixi_couple") ~= 0 then return false end
    --[[
    local pid = player:getMark("qixi_pay_court")
    local p = Fk:currentRoom():getPlayerById(pid)
    return not p or p.dead or p:getMark("qixi_couple") ~= 0
    --]]
    return true
  end,
  card_num = 1,
  target_num = 1,
  prompt = "#qixi_jieban-promot",
  card_filter = function(self, to_select, selected)
    if #selected ~= 0 then return end
    local c = Fk:getCardById(to_select)
    return c.trueName == 'peach' or c.sub_type == Card.SubtypeArmor
  end,
  target_filter = function(self, to_select, selected, cards)
    return #selected == 0 and canPayCourtTo(Self, Fk:currentRoom():getPlayerById(to_select)) and #cards == 1
  end,
  on_use = function (self, room, effect)
    local from = room:getPlayerById(effect.from)
    local to = room:getPlayerById(effect.tos[1])
    room:obtainCard(to, effect.cards[1], true, fk.ReasonGive)

    --- set court mark
    ---@param from ServerPlayer
    ---@param to ServerPlayer
    ---@param clear? bool
    local function setCourt(from, to, clear)
      if clear then
        for _, p in ipairs{from, to} do
          room:setPlayerMark(p, "qixi_pay_court", 0)
          room:setPlayerMark(p, "@qixi_pay_court", 0)
        end
      else
        room:setPlayerMark(from, "qixi_pay_court", to.id)
        room:setPlayerMark(from, "@qixi_pay_court", to.general)
      end
    end

    setCourt(from, to)
    if to:getMark('qixi_pay_court') == from.id then
      setCourt(from, to, true)

      room:setPlayerMark(from, "qixi_couple", to.id)
      room:setPlayerMark(to, "qixi_couple", from.id)
      addCoupleSkill(from, to)
      local couple = isCoupleGeneral(from, to)
      if couple then
        room:setPlayerMark(from, to.gender == General.Female and "@qixi_couple_pink" or "@qixi_couple_blue", to.general)
        room:setPlayerMark(to, from.gender == General.Female and "@qixi_couple_pink" or "@qixi_couple_blue", from.general)
      else
        room:setPlayerMark(from, "@qixi_couple", to.general)
        room:setPlayerMark(to, "@qixi_couple", from.general)
      end
    end
  end
}
Fk:addSkill(qixi_jieban)

Fk:loadTranslationTable{
  ['qixi_jieban&'] = '结伴',
  [':qixi_jieban&'] = '出牌阶段限一次，若你没有伴侣，你可以将一张' ..
    '【桃】或者防具牌交给一名未结伴的异性角色并将其设为追求目标；' ..
    '然后若其的追求目标是你，双方移除追求目标并结为伴侣。' ..
    '<br/>伴侣确定后就无法更改，即使死亡也无法将二人分开。',
  ["#qixi_jieban-promot"] = "结伴：将一张【桃】或者防具牌交给一名未结伴的异性角色，追求该角色",
}

local qixi_get_logic = function()
  ----@class qixi_logic : GameLogic
  local qixi_logic = GameLogic:subclass("qixi_logic")

  function qixi_logic:assignRoles()
    local room = self.room ---@type Room
    local n = #room.players
    local half = n // 2
    local t = {}
    for _ = 1, half do
      table.insert(t, "@!qixi_male")
      table.insert(t, "@!qixi_female")
    end
    if #t < n then
      table.insert(t, table.random{ "@!qixi_male", "@!qixi_female" })
    end
    table.shuffle(t)

    for i, p in ipairs(room.players) do
      room:addPlayerMark(p, t[i])
      room:setPlayerProperty(p, "role", "hidden")
      room:setPlayerProperty(p, "role_shown", true)
    end

    -- for adjustSeats
    room.players[1].role = "lord"
  end

  function qixi_logic:chooseGenerals()
    local room = self.room --- @type Room
    local nonlord = room.players

    local males, females = {}, {}
    for _, p in ipairs(nonlord) do
      if p:getMark("@!qixi_male") > 0 then
        table.insert(males, p)
      else
        table.insert(females, p)
      end
    end

    local male_generals,female_generals = {}, {}

    for _, gname in ipairs(room.general_pile) do
      local general = Fk.generals[gname]
      if general.gender == General.Male then
        table.insert(male_generals, gname)
      elseif general.gender == General.Female then
        table.insert(female_generals, gname)
      end
      -- no Bigender & Agender
    end
    local generalNum = math.min(room.settings.generalNum, #male_generals // #males, #female_generals // #females)
    if generalNum < 3 then
      room:sendLog{ type = "#NoGeneralDraw", toast = true }
      room:gameOver("")
    end

    local n = room.settings.enableDeputy and 2 or 1
    local lord = room:getLord()
    room:setCurrent(lord)
    lord.role = "hidden"

    for _, p in ipairs(nonlord) do
      room:setPlayerMark(p, "@seat", "seat#"..p.seat)
    end

    local req = Request:new(nonlord, "AskForGeneral")
    for i, p in ipairs(nonlord) do
      local arg = {}
      local t = (p:getMark("@!qixi_female") > 0) and female_generals or male_generals
      for _ = 1, generalNum do
        table.insert(arg, table.remove(t))
      end
      req:setData(p, { arg, n })
      req:setDefaultReply(p, table.random(arg, n))
    end

    for _, p in ipairs(nonlord) do
      local result = req:getResult(p)
      local general, deputy = result[1], result[2]
      room:findGeneral(general)
      room:findGeneral(deputy)
      room:prepareGeneral(p, general, deputy)
    end

    for _, p in ipairs(nonlord) do
      room:setPlayerMark(p, "@seat", 0)
    end

    room:askForChooseKingdom(nonlord)

    room:setBanner("@[:]mode_desc", "qixi_short_desc")
  end

  function qixi_logic:attachSkillToPlayers()
    GameLogic.attachSkillToPlayers(self)
    local room = self.room
    room:setTag("SkipNormalDeathProcess", true)
    for _, p in ipairs(room.players) do
      room:handleAddLoseSkills(p, 'qixi_jieban&')
      attachRandomSkill(p)
    end
  end

  return qixi_logic
end

---@param killer ServerPlayer
---@param victim ServerPlayer
local function rewardAndPunish(killer, victim)
  if killer.dead then return end
  local room = killer.room
  local c = killer:getMark('qixi_couple')
  if victim.id == c then
    killer:throwAllCards("he")
    room:loseHp(killer, 1, '#qixi_rule')
  else
    local couple = room:getPlayerById(c)
    if couple then
      if not couple.dead then
        killer:drawCards(1, "#qixi_rule")
        couple:drawCards(1, "#qixi_rule")
      else
        killer:drawCards(2, "#qixi_rule")
      end
    else
      killer:drawCards(3, "#qixi_rule")
    end
  end
end

local qixi_rule = fk.CreateTriggerSkill{
  name = "#qixi_rule",
  priority = 0.001,
  mute = true,
  events = {
    fk.GameOverJudge, fk.BuryVictim, fk.DamageCaused,
    fk.DrawNCards, fk.EventPhaseStart,
  },
  can_trigger = function(self, event, target, player, data)
    if target ~= player then return false end
    if event == fk.DamageCaused then
      return player:getMark('qixi_couple') == 0 and data.damage >= (data.to.hp + data.to.shield)
    elseif event == fk.DrawNCards then
      return player:getMark("@qixi_couple_pink") ~= 0
    elseif event == fk.EventPhaseStart then
      return player.phase == Player.Finish and player:getMark("@qixi_couple_blue") ~= 0
    end
    return true
  end,
  on_cost = Util.TrueFunc,
  on_use = function(self, event, target, player, data)
    local room = player.room
    if event == fk.GameOverJudge then
      room:setTag("SkipGameRule", true)
      local winner = Fk.game_modes[room.settings.gameMode]:getWinner(player)
      if winner ~= "" then
        local alive = table.filter(room.alive_players, function(p)
          return not p.surrendered
        end)
        local p = alive[1]
        room:setPlayerProperty(p, "role", "renegade")
        local c = room:getPlayerById(p:getMark("qixi_couple"))
        if c then
          room:setPlayerProperty(c, "role", "renegade")
        end

        room:gameOver(winner)
        return true
      end
    elseif event == fk.BuryVictim then
      local damage = data.damage
      if damage and damage.from then
        local killer = damage.from
        rewardAndPunish(killer, player);
      end
    elseif event == fk.DamageCaused then
      if table.find(room:getOtherPlayers(player), function(p)
        return canPayCourtTo(player, p)
      end) then
        room:sendLog{type = "#QixiModeNegative", from = player.id, toast = true }
        return true
      else
        data.damage = data.damage + 1
      end
    elseif event == fk.DrawNCards then
      player:broadcastSkillInvoke("yingzi")
      room:notifySkillInvoked(player, "yingzi", "drawcard")
      data.n = data.n + 1
    elseif event == fk.EventPhaseStart then
      player:broadcastSkillInvoke("biyue")
      room:notifySkillInvoked(player, "biyue", "drawcard")
      player:drawCards(1, self.name)
    end
  end,
}
Fk:addSkill(qixi_rule)

local qixi_mode = fk.CreateGameMode{
  name = "qixi_mode",
  minPlayer = 4,
  maxPlayer = 8,
  logic = qixi_get_logic,
  rule = qixi_rule,
  winner_getter = function(self, victim)
    if not victim.surrendered and victim.rest > 0 then
      return ""
    end
    local room = victim.room
    local alive = table.filter(room.players, function(p)
      return not p.surrendered and not (p.dead and p.rest == 0)
    end)
    if #alive > 2 then return "" end
    if #alive == 1 then
      return "renegade"
    else
      if alive[1]:getMark("qixi_couple") == alive[2].id then
        return "renegade"
      else
        return ""
      end
    end
  end,
  surrender_func = function(self, playedTime)
    local room = Fk:currentRoom()
    local canSurrender = true
    local coupleId = Self:getMark("qixi_couple")
    if coupleId ~= 0 then
      local couple = room:getPlayerById(coupleId)
      if couple and (couple.rest > 0 or not couple.dead) then
        canSurrender = false
      end
    end
    if canSurrender then
      ---@type ClientPlayer[]
      local others = table.filter(Fk:currentRoom().players, function(p)
        return (p.rest > 0 or not p.dead) and p ~= Self and p.id ~= coupleId
      end)
      if #others > 2 then
        canSurrender = false
      elseif #others == 2 then
        if others[1]:getMark("qixi_couple") ~= others[2].id and others[1]:getMark("qixi_couple") ~= others[2].id then
          canSurrender = false
        end
      end
    end
    return { { text = "qixi_surrender", passed = canSurrender } }
  end,
}

Fk:loadTranslationTable{
  ['qixi_mode'] = '七夕模式',
  [':qixi_mode'] = qixi_desc,

  ["#qixi_rule"] = "七夕规则",
  ['@qixi_pay_court'] = '追求',
  ['@qixi_couple'] = '伴侣',
  ['@qixi_couple_blue'] = '<font color="#87CEFA">伴侣</font>',
  ['@qixi_couple_pink'] = '<font color="#FFB6C1">伴侣</font>',
  ["qixi_surrender"] = "未结伴或伴侣已死亡，且仅剩一名其他角色或一对其他伴侣",

  ["@[:]mode_desc"] = "模式简介",
  ["qixi_short_desc"] = "七夕",
  [":qixi_short_desc"] = "◆获胜条件为击杀除了自己和伴侣之外的所有其他角色。"
  .."<br>◆所有角色拥有模式专属技能“结伴”，以及一个随机技能"
  .."<br>◆发动技能“结伴”追求异性，互相发动“结伴”后即结为伴侣。"
  .."<br>◆当无伴侣的角色造成致命伤害时，若场上没有可以被追求的角色，则伤害+1，否则防止伤害。"
  .."<br>◆击杀伴侣的角色弃置所有牌并失去一点体力。"
  .."<br>◆击杀非伴侣角色，自己和伴侣各摸牌。"
  .."<br>"
  .."<br>结伴后，双方失去模式赋予的技能和“结伴”，然后根据男方的势力获得如下技能："
  .."<br>   魏：【舍身》当伴侣不以此法受到伤害时，你可以将伤害转移给自己。"
  .."<br>   蜀：【共斗》每回合限一次，当伴侣使用的非转化【杀】结算完成后，你可以视为对相同的目标使用一张【杀】。"
  .."<br>   吴：【连枝》使用装备牌后可以令伴侣摸一张牌。"
  .."<br>   群：【泣别》伴侣在求桃结束即将死亡时，你可以将所有体力值和武将牌上的技能交给伴侣（伴侣至少会回复至1点体力），然后阵亡。"
  .."<br>   其他：不会得到伴侣技，但也不失去模式赋予的那个技能。"
  .."<br>"
  .."<br>特别的，当原配夫妻（例如周瑜&小乔）结伴时，男方获得“英姿”效果，女方获得“闭月”效果（不显示，无法被无效，锁定发动，标的）",

  ["#QixiModeNegative"] = "由于 %from 没有伴侣，防止其造成致命伤害",
}

return qixi_mode
